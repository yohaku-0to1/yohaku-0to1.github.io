<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MP4フレーム抽出ツール</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- JSZip CDN -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <style>
        /* Interフォントの読み込み */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #111827; /* Tailwind bg-gray-900 */
        }
        /* カスタムスタイル */
        .card {
            background-color: #1f2937; /* Tailwind bg-gray-800 */
            border-radius: 0.75rem; /* rounded-xl */
            padding: 1.5rem; /* p-6 */
            margin-bottom: 1.5rem; /* mb-6 */
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        }
        /* ファイル入力のスタイル */
        input[type="file"]::file-selector-button {
            background-color: #3b82f6; /* bg-blue-600 */
            color: white;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 0.375rem; /* rounded-md */
            cursor: pointer;
            transition: background-color 0.2s;
        }
        input[type="file"]::file-selector-button:hover {
            background-color: #2563eb; /* bg-blue-700 */
        }
        /* ボタンのスタイル */
        .btn {
            background-color: #10b981; /* bg-emerald-500 */
            color: white;
            font-weight: 500;
            padding: 0.75rem 1.5rem;
            border-radius: 0.5rem; /* rounded-lg */
            cursor: pointer;
            transition: background-color 0.2s;
        }
        .btn:hover {
            background-color: #059669; /* bg-emerald-600 */
        }
        .btn:disabled {
            background-color: #4b5563; /* bg-gray-600 */
            cursor: not-allowed;
        }
        /* スピナー */
        .loader {
            border: 4px solid #374151; /* border-gray-700 */
            border-top: 4px solid #10b981; /* border-emerald-500 */
            border-radius: 50%;
            width: 1.5rem; /* w-6 */
            height: 1.5rem; /* h-6 */
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        /* 入力欄のスタイル */
        .form-input {
            background-color: #374151; /* bg-gray-700 */
            border: 1px solid #4b5563; /* border-gray-600 */
            color: white;
            border-radius: 0.375rem; /* rounded-md */
            padding: 0.5rem 0.75rem;
            width: 100%;
        }
        .form-input:focus {
            outline: none;
            border-color: #10b981; /* border-emerald-500 */
            box-shadow: 0 0 0 2px #10b981;
        }
        .form-label {
            margin-bottom: 0.5rem;
            display: block;
            font-weight: 500;
        }
    </style>
    <!-- Google tag (gtag.js) -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-1GQRC5L80E"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());

      gtag('config', 'G-1GQRC5L80E');
    </script>
</head>
<body class="text-gray-200">

    <div class="container mx-auto max-w-3xl p-4 md:p-8">
        <h1 class="text-3xl font-bold text-center text-white mb-6">MP4フレーム抽出ツール</h1>
        <p class="text-center text-gray-400 mb-8">MP4動画をアップロードし、指定した条件でフレームを抽出し、ZIPファイルでダウンロードします。</p>

        <!-- ステップ1: ファイル選択 -->
        <div class="card">
            <h2 class="text-xl font-semibold text-white mb-4">ステップ1: 動画ファイルを選択</h2>
            <input type="file" id="fileInput" accept="video/mp4" class="w-full text-sm text-gray-400 file:mr-4">
        </div>

        <!-- ステップ2: プレビュー -->
        <div class="card" id="previewCard" style="display: none;">
            <h2 class="text-xl font-semibold text-white mb-4">ステップ2: プレビュー</h2>
            <video id="videoPlayer" controls class="w-full rounded-lg bg-black" muted playsinline></video>
            <div id="videoInfo" class="text-sm text-gray-400 mt-2"></div>
        </div>

        <!-- ステップ3: 抽出設定 -->
        <div class="card" id="settingsCard" style="display: none;">
            <h2 class="text-xl font-semibold text-white mb-4">ステップ3: 抽出設定</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div>
                    <label for="fpsInput" class="form-label">抽出レート (FPS)</label>
                    <input type="number" id="fpsInput" value="10" min="1" max="60" class="form-input">
                    <p class="text-xs text-gray-500 mt-1">1秒あたりに抽出するフレーム数。</p>
                </div>
                <div>
                    <label for="formatInput" class="form-label">画像フォーマット</label>
                    <select id="formatInput" class="form-input">
                        <option value="image/png">PNG (高品質)</option>
                        <option value="image/jpeg">JPEG (軽量)</option>
                    </select>
                </div>
                <div>
                    <label for="startTimeInput" class="form-label">開始時間 (秒)</label>
                    <input type="number" id="startTimeInput" value="0" min="0" class="form-input">
                </div>
                <div>
                    <label for="endTimeInput" class="form-label">終了時間 (秒)</label>
                    <input type="number" id="endTimeInput" value="0" min="0" class="form-input">
                    <p class="text-xs text-gray-500 mt-1">0の場合は動画の最後まで。</p>
                </div>
            </div>
        </div>

        <!-- ステップ4: 抽出実行 -->
        <div class="card" id="controlCard" style="display: none;">
            <h2 class="text-xl font-semibold text-white mb-4">ステップ4: フレーム抽出</h2>
            <button id="extractButton" class="btn w-full">
                抽出開始
            </button>
            <div id="statusArea" class="mt-4 text-center text-gray-400" style="display: none;">
                <div class="flex items-center justify-center space-x-2">
                    <div class="loader"></div>
                    <span id="statusText">処理中です...</span>
                </div>
                <div id="progressText" class="text-sm mt-2">フレーム 0 / 0</div>
            </div>
        </div>

        <!-- ステップ5: ダウンロード -->
        <div class="card" id="downloadCard" style="display: none;">
            <h2 class="text-xl font-semibold text-white mb-4">ステップ5: ダウンロード</h2>
            <div id="downloadArea" class="text-center">
                <!-- ダウンロードリンクがここに追加されます -->
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // DOM要素の取得
            const fileInput = document.getElementById('fileInput');
            const previewCard = document.getElementById('previewCard');
            const videoPlayer = document.getElementById('videoPlayer');
            const videoInfo = document.getElementById('videoInfo');
            const settingsCard = document.getElementById('settingsCard');
            const controlCard = document.getElementById('controlCard');
            const extractButton = document.getElementById('extractButton');
            const statusArea = document.getElementById('statusArea');
            const statusText = document.getElementById('statusText');
            const progressText = document.getElementById('progressText');
            const downloadCard = document.getElementById('downloadCard');
            const downloadArea = document.getElementById('downloadArea');
            
            const fpsInput = document.getElementById('fpsInput');
            const formatInput = document.getElementById('formatInput');
            const startTimeInput = document.getElementById('startTimeInput');
            const endTimeInput = document.getElementById('endTimeInput');

            let videoFile = null;
            let canvas = null;
            let ctx = null;
            let zip = null;
            let isExtracting = false;

            // FPSを推定する関数
            function estimateFps(video) {
                return new Promise(resolve => {
                    const frameTimes = [];
                    let frameCount = 0;
                    const sampleSize = 30; // サンプルするフレーム数

                    // 一時的に動画をミュートし、再生準備
                    const originalMuted = video.muted;
                    video.muted = true;
                    video.currentTime = 0;

                    const callback = (now, metadata) => {
                        // 最初のフレーム時間は基準点として記録
                        if (frameCount > 0) {
                            const lastTime = frameTimes[frameTimes.length - 1];
                            // タイムスタンプが前回と同じフレームは無視
                            if (metadata.mediaTime > lastTime) {
                                frameTimes.push(metadata.mediaTime);
                            }
                        } else {
                            frameTimes.push(metadata.mediaTime);
                        }
                        
                        frameCount++;

                        // 十分なサンプルが集まったか、動画の終わりに達したら計算
                        if (frameCount >= sampleSize || video.currentTime >= video.duration) {
                            video.pause();
                            video.removeEventListener('timeupdate', onTimeUpdate); // 不要なリスナーを削除
                            
                            const first = frameTimes[0];
                            const last = frameTimes[frameTimes.length - 1];
                            const duration = last - first;
                            
                            let avgFps = 24; // デフォルト値
                            if (duration > 0 && frameTimes.length > 1) {
                                avgFps = (frameTimes.length - 1) / duration;
                            }
                            
                            // 状態を元に戻す
                            video.currentTime = 0;
                            video.muted = originalMuted;
                            resolve(avgFps);
                            return; // コールバックチェーンを終了
                        }
                        
                        // 次のフレームを要求
                        video.requestVideoFrameCallback(callback);
                    };

                    const onTimeUpdate = () => {
                        // 再生が始まったら最初のコールバックを要求
                        video.requestVideoFrameCallback(callback);
                    };
                    
                    video.addEventListener('timeupdate', onTimeUpdate, { once: true });
                    video.play().catch(e => {
                        console.error("FPS推定のための再生に失敗:", e);
                        video.muted = originalMuted; // エラー時もミュート状態を戻す
                        resolve(null); // エラーの場合はnullを返す
                    });
                });
            }

            // ファイル選択時の処理
            fileInput.addEventListener('change', (event) => {
                videoFile = event.target.files[0];
                if (videoFile) {
                    const url = URL.createObjectURL(videoFile);
                    videoPlayer.src = url;
                    
                    videoPlayer.addEventListener('loadedmetadata', async () => {
                        videoInfo.textContent = `解像度: ${videoPlayer.videoWidth}x${videoPlayer.videoHeight}, 長さ: ${videoPlayer.duration.toFixed(2)}秒`;
                        endTimeInput.value = videoPlayer.duration.toFixed(2);
                        endTimeInput.max = videoPlayer.duration.toFixed(2);
                        startTimeInput.max = videoPlayer.duration.toFixed(2);

                        // FPSを推定してデフォルト値に設定
                        const estimatedFps = await estimateFps(videoPlayer);
                        if (estimatedFps) {
                            fpsInput.value = Math.round(estimatedFps);
                            videoInfo.textContent += `, FPS: ~${Math.round(estimatedFps)}`;
                        }

                    }, { once: true });

                    previewCard.style.display = 'block';
                    settingsCard.style.display = 'block';
                    controlCard.style.display = 'block';
                    downloadCard.style.display = 'none';
                    downloadArea.innerHTML = '';
                    extractButton.disabled = false;
                    extractButton.innerText = '抽出開始';
                }
            });

            // 抽出ボタンクリック時の処理
            extractButton.addEventListener('click', async () => {
                if (!videoFile) {
                    alert('まず動画ファイルを選択してください。');
                    return;
                }
                if (isExtracting) {
                    isExtracting = false;
                    statusText.innerText = '処理を停止しています...';
                    extractButton.disabled = true;
                    return;
                }

                isExtracting = true;
                zip = new JSZip();
                
                const fps = parseFloat(fpsInput.value);
                const startTime = parseFloat(startTimeInput.value);
                let endTime = parseFloat(endTimeInput.value);
                const imageFormat = formatInput.value;
                const imageExtension = imageFormat === 'image/jpeg' ? 'jpg' : 'png';

                if (endTime <= 0 || endTime > videoPlayer.duration) {
                    endTime = videoPlayer.duration;
                }

                if (startTime >= endTime) {
                    alert('開始時間は終了時間より前に設定してください。');
                    isExtracting = false;
                    return;
                }

                extractButton.innerText = '停止';
                statusArea.style.display = 'block';
                statusText.innerText = 'フレーム抽出中...';
                
                if (!canvas) {
                    canvas = document.createElement('canvas');
                }
                canvas.width = videoPlayer.videoWidth;
                canvas.height = videoPlayer.videoHeight;
                ctx = canvas.getContext('2d');

                const interval = 1 / fps;
                let currentTime = startTime;
                let frameCount = 0;
                const totalFrames = Math.floor((endTime - startTime) / interval);

                async function captureFrame() {
                    if (!isExtracting || currentTime > endTime) {
                        finishExtraction(frameCount);
                        return;
                    }

                    progressText.innerText = `フレーム ${frameCount + 1} / ${totalFrames}`;
                    
                    videoPlayer.currentTime = currentTime;

                    await new Promise(resolve => {
                        videoPlayer.addEventListener('seeked', () => resolve(), { once: true });
                    });

                    ctx.drawImage(videoPlayer, 0, 0, canvas.width, canvas.height);
                    const blob = await new Promise(resolve => canvas.toBlob(resolve, imageFormat, 0.9));
                    
                    if(isExtracting) {
                        const fileName = `frame_${String(frameCount + 1).padStart(6, '0')}.${imageExtension}`;
                        zip.file(fileName, blob);

                        frameCount++;
                        currentTime += interval;
                        
                        requestAnimationFrame(captureFrame);
                    } else {
                        finishExtraction(frameCount);
                    }
                }

                captureFrame();
            });

            // 抽出完了処理
            function finishExtraction(extractedFrames) {
                if (!isExtracting && extractedFrames === 0) { // 抽出前に停止した場合
                    statusArea.style.display = 'none';
                    extractButton.innerText = '抽出開始';
                    extractButton.disabled = false;
                    return;
                }
                
                isExtracting = false;
                statusText.innerText = 'ZIPファイルを生成中...';

                if (extractedFrames === 0) {
                    statusArea.style.display = 'none';
                    extractButton.innerText = '再度抽出する';
                    extractButton.disabled = false;
                    return;
                }

                zip.generateAsync({ type: 'blob' }, (metadata) => {
                    statusText.innerText = `ZIP圧縮中: ${Math.round(metadata.percent)}%`;
                })
                .then((content) => {
                    const zipUrl = URL.createObjectURL(content);
                    const downloadLink = document.createElement('a');
                    downloadLink.href = zipUrl;
                    
                    const baseName = videoFile.name.split('.').slice(0, -1).join('.') || 'video';
                    downloadLink.download = `${baseName}_frames.zip`;
                    
                    downloadLink.innerText = `ダウンロード: ${baseName}_frames.zip (${extractedFrames} フレーム)`;
                    downloadLink.className = 'text-emerald-400 hover:text-emerald-300 font-medium underline';
                    
                    downloadArea.innerHTML = '';
                    downloadArea.appendChild(downloadLink);
                    
                    statusArea.style.display = 'none';
                    downloadCard.style.display = 'block';
                    extractButton.disabled = false;
                    extractButton.innerText = '再度抽出する';
                })
                .catch((err) => {
                    console.error(err);
                    statusText.innerText = `エラーが発生しました: ${err.message}`;
                    extractButton.disabled = false;
                    extractButton.innerText = '再試行';
                });
            }
        });
    </script>

</body>
</html>